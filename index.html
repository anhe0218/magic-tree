<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>圣诞树</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
    "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
  }
}
</script>

<style>
html,body{
  margin:0;
  overflow:hidden;
  background:#000;
  color:#fceea7;
  font-family:"Times New Roman",serif
}
canvas{display:block}

/* Loader */
#loader{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:10;
  transition:opacity 1.2s
}
#loader.fade{opacity:0;pointer-events:none}
.spinner{
  width:40px;
  height:40px;
  border-radius:50%;
  border:4px solid rgba(255,255,255,.15);
  border-top:1px solid #d4af37;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
#loader span{
  margin-top:14px;
  letter-spacing:3px;
  color:#d4af37
}

/* UI */
.ui{
  position:fixed;
  top:20px;
  width:100%;
  text-align:center;
}
h1{
  font-family:'Cinzel',serif;
  font-size:56px;
  background:linear-gradient(#fff,#d4af37);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  text-shadow:0 0 20px rgba(212,175,55,.6)
}

/* 手势状态提示左上角 */
#status-pill{
  position:fixed;
  top:20px;
  left:20px;
  padding:8px 16px;
  background:rgba(0,0,0,0.6);
  border:1px solid rgba(212,175,55,0.3);
  border-radius:20px;
  color:#d4af37;
  font-size:14px;
  z-index:11;
  backdrop-filter:blur(4px);
}

/* Webcam hidden */
#cv{
  position:fixed;
  right:0;
  bottom:0;
  width:160px;
  height:120px;
  opacity:0;
}
</style>
</head>

<body>
<div id="loader">
  <div class="spinner"></div>
  <span>LOADING HOLIDAY MAGIC</span>
</div>

<div class="ui">
  <h1>Merry Christmas</h1>
</div>

<div id="status-pill">系统初始化...</div>

<div id="cv">
  <video id="video" autoplay playsinline></video>
</div>

<canvas id="webgl"></canvas>

<script type="module">
import * as THREE from 'three';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

/* ================= STATE ================= */
const STATE={ mode:'SCATTER' };

/* ================= THREE ================= */
const renderer=new THREE.WebGLRenderer({canvas:webgl,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
renderer.toneMapping=THREE.ReinhardToneMapping;
renderer.toneMappingExposure=2.2;

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,.1,200);
camera.position.set(0,2,50);

scene.environment=new THREE.PMREMGenerator(renderer)
.fromScene(new RoomEnvironment(),.04).texture;

scene.add(new THREE.AmbientLight(0xffffff,.6));
scene.add(new THREE.PointLight(0xffaa55,2));

const warm=new THREE.SpotLight(0xd4af37,1200);
warm.position.set(30,40,40);
scene.add(warm);

const cool=new THREE.SpotLight(0x3366ff,600);
cool.position.set(-30,20,-30);
scene.add(cool);

/* Post */
const composer=new EffectComposer(renderer);
composer.addPass(new RenderPass(scene,camera));
composer.addPass(new UnrealBloomPass(
  new THREE.Vector2(innerWidth,innerHeight),
  0.45,0.4,0.7
));

const mainGroup=new THREE.Group();
scene.add(mainGroup);

/* ================= UTIL ================= */
function randomInSphere(min,max){
  const u=Math.random(),v=Math.random();
  const r=THREE.MathUtils.lerp(min,max,Math.random());
  const th=2*Math.PI*u;
  const ph=Math.acos(2*v-1);
  return new THREE.Vector3(
    r*Math.sin(ph)*Math.cos(th),
    r*Math.cos(ph),
    r*Math.sin(ph)*Math.sin(th)
  );
}

/* ================= PARTICLE ================= */
class Particle{
  constructor(mesh){
    this.mesh=mesh;
    this.v=randomInSphere(.002,.02);
    this.target=new THREE.Vector3();
    this.scaleTarget=1;
    mainGroup.add(mesh);
  }
  update(){
    this.mesh.position.lerp(this.target,.07);
    this.mesh.scale.lerp(
      new THREE.Vector3(this.scaleTarget,this.scaleTarget,this.scaleTarget),.08
    );
    if(STATE.mode==='SCATTER'){
      this.mesh.rotation.x+=this.v.x;
      this.mesh.rotation.y+=this.v.y;
    }
  }
}
const particles=[];

/* ================= GEOMETRY ================= */
const gold=new THREE.MeshStandardMaterial({color:0xd4af37,metalness:.9,roughness:.2});
const green=new THREE.MeshStandardMaterial({color:0x0b3d2e});

for(let i=0;i<1500;i++){
  const g=Math.random()>.5
    ?new THREE.BoxGeometry(.6,.6,.6)
    :new THREE.SphereGeometry(.4,16,16);
  const m=Math.random()>.5?gold:green;
  particles.push(new Particle(new THREE.Mesh(g,m)));
}

for(let i=0;i<2500;i++){
  particles.push(new Particle(
    new THREE.Mesh(
      new THREE.SphereGeometry(.05,8,8),
      new THREE.MeshBasicMaterial({color:0xffffff})
    )
  ));
}

/* Candy Cane */
const c=document.createElement('canvas');
c.width=c.height=256;
const ctx=c.getContext('2d');
ctx.fillStyle='#fff';
ctx.fillRect(0,0,256,256);
ctx.strokeStyle='#c00';
ctx.lineWidth=30;
for(let i=-256;i<512;i+=60){
  ctx.beginPath();
  ctx.moveTo(i,0);
  ctx.lineTo(i+256,256);
  ctx.stroke();
}
const caneTex=new THREE.CanvasTexture(c);
caneTex.colorSpace=THREE.SRGBColorSpace;

for(let i=0;i<12;i++){
  const pts=[]; for(let t=0;t<=1;t+=.1){
    pts.push(new THREE.Vector3(
      Math.cos(Math.PI*t)*.8,
      t*6,
      Math.sin(Math.PI*t)*.8
    ));
  }
  const curve=new THREE.CatmullRomCurve3(pts);
  particles.push(new Particle(
    new THREE.Mesh(
      new THREE.TubeGeometry(curve,64,.25,8),
      new THREE.MeshStandardMaterial({map:caneTex})
    )
  ));
}

/* ================= STATES ================= */
function setMode(m){
  if(STATE.mode!==m){
    STATE.mode=m;
    updateTargets();
  }
}

function updateTargets(){
  if(STATE.mode==='SCATTER'){
    particles.forEach(p=>{ p.target.copy(randomInSphere(18,36)); p.scaleTarget=1; });
  }
  if(STATE.mode==='TREE'){
    particles.forEach((p,i)=>{
      const t=i/particles.length;
      const r=12*(1-t);
      const a=t*50*Math.PI;
      p.target.set(Math.cos(a)*r,t*24-6,Math.sin(a)*r);
      p.scaleTarget=1;
    });
  }
  if(STATE.mode==='FOCUS'){
    particles.forEach(p=>{ p.target.copy(randomInSphere(0,4)); p.scaleTarget=1.6; });
  }
}

/* ================= MEDIAPIPE ================= */
async function initCV(){
  const statusPill=document.getElementById('status-pill');
  const vision=await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );
  const hand=await HandLandmarker.createFromOptions(vision,{
    baseOptions:{
      modelAssetPath:"https://storage.googleapis.com/mediapipe-assets/hand_landmarker.task",
      delegate:"GPU"
    },
    runningMode:"VIDEO",
    numHands:1
  });

  const video=document.getElementById('video');
  video.srcObject=await navigator.mediaDevices.getUserMedia({video:true});

  function loop(){
    if(video.readyState>=2){
      const r=hand.detectForVideo(video,performance.now());
      if(r.landmarks?.length){
        const lm=r.landmarks[0];
        const pinch=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);
        const avg=(lm[8].y+lm[12].y+lm[16].y+lm[20].y)/4;
        const dist=Math.abs(avg-lm[0].y);

        if(pinch<.05){
            setMode('TREE');
            statusPill.innerText="手势：树形";
        } else if(dist<.25){
            setMode('FOCUS');
            statusPill.innerText="手势：聚焦";
        } else if(dist>.4){
            setMode('SCATTER');
            statusPill.innerText="手势：散开";
        }

        statusPill.style.color="#00FF00";
        statusPill.style.borderColor="#00FF00";

        mainGroup.rotation.y=(lm[9].x-.5)*2;
        mainGroup.rotation.x=(lm[9].y-.5)*1.5;
      } else {
        statusPill.innerText="待机：请在镜头前张开手";
        statusPill.style.color="#d4af37";
        statusPill.style.borderColor="rgba(212,175,55,0.3)";
      }
    }
    requestAnimationFrame(loop);
  }
  loop();
}

/* ================= LOOP ================= */
function animate(){
  particles.forEach(p=>p.update());
  composer.render();
  requestAnimationFrame(animate);
}

/* ================= INIT ================= */
updateTargets();
initCV();
animate();
loader.classList.add('fade');
</script>
</body>
</html>
